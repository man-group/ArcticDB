name: Build with conda

permissions:
  contents: read

run-name: Building ${{github.ref_name}} on ${{github.event_name}} by ${{github.actor}}

concurrency:
  group: ${{github.ref}}-${{github.workflow}}
  cancel-in-progress: true

on:
  push:
    branches:
      - master
  # For Pull-Requests, this runs the CI on merge commit of HEAD with the target
  # branch instead of HEAD, testing against potential new states introduced in
  # the target branch.
  # See: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request
  pull_request:

  workflow_dispatch:
    inputs:
      run_on_arm_mac:
        description: 'Run on arm macos'
        type: boolean
        required: false
        default: false
      run_cpp_tests:
        description: 'Run C++ tests'
        type: boolean
        required: true
        default: true
      persistent_storage:
        description: "Run against what persistent storage type? (no is LMDB/default)"
        type: choice
        options:
          - 'no'
          - 'AWS_S3'
          - 'GCPXML'
          - 'AZURE'
        default: 'no'
      debug_enabled:
        type: boolean
        description: 'Run the build with debugging enabled'
        required: false
        default: false
      run_enable_logging:
        description: 'Enabled debug logging'
        type: boolean
        required: false
        default: false
      run_commandline:
        description: 'Run custom commandline before tests, e.g. export ARCTICDB_STORAGE_AZURE=1; ...'
        type: string
        required: false
        default: ""
      run_custom_pytest_command:
        description: '*Run custom pytest command, instead of standard (Note: curdir is project root), or pass additional arguments to default command'
        type: string
        required: false
        default: ""

jobs:

  # ── linux_64 ─────────────────────────────────────────────────────────────────
  linux_64:
    name: linux_64
    uses: ./.github/workflows/build_with_conda_common.yml
    with:
      platform:                  linux_64
      runner:                    ubuntu-22.04
      cmake_preset:              linux-conda-release
      cpp_out_dir:               cpp/out/linux-conda-release-build
      conda_cache_key:           conda-env-linux_64
      run_cpp_tests:             ${{ inputs.run_cpp_tests == true || github.event_name != 'workflow_dispatch' }}
      persistent_storage:        ${{ inputs.persistent_storage || 'no' }}
      debug_enabled:             ${{ inputs.debug_enabled || false }}
      run_enable_logging:        ${{ inputs.run_enable_logging || false }}
      run_commandline:           ${{ inputs.run_commandline || '' }}
      run_custom_pytest_command: ${{ inputs.run_custom_pytest_command || '' }}
    secrets:
      AWS_S3_ACCESS_KEY:       ${{ secrets.AWS_S3_ACCESS_KEY }}
      AWS_S3_SECRET_KEY:       ${{ secrets.AWS_S3_SECRET_KEY }}
      GCP_S3_ACCESS_KEY:       ${{ secrets.GCP_S3_ACCESS_KEY }}
      GCP_S3_SECRET_KEY:       ${{ secrets.GCP_S3_SECRET_KEY }}
      AZURE_CONNECTION_STRING: ${{ secrets.AZURE_CONNECTION_STRING }}

  # ── linux_aarch64 ────────────────────────────────────────────────────────────
  linux_aarch64:
    name: linux_aarch64
    uses: ./.github/workflows/build_with_conda_common.yml
    with:
      platform:                  linux_aarch64
      runner:                    ubuntu-22.04-arm
      cmake_preset:              linux-conda-release
      cpp_out_dir:               cpp/out/linux-conda-release-build
      conda_cache_key:           conda-env-linux_aarch64
      run_cpp_tests:             ${{ inputs.run_cpp_tests == true || github.event_name != 'workflow_dispatch' }}
      persistent_storage:        ${{ inputs.persistent_storage || 'no' }}
      debug_enabled:             ${{ inputs.debug_enabled || false }}
      run_enable_logging:        ${{ inputs.run_enable_logging || false }}
      run_commandline:           ${{ inputs.run_commandline || '' }}
      run_custom_pytest_command: ${{ inputs.run_custom_pytest_command || '' }}
    secrets:
      AWS_S3_ACCESS_KEY:       ${{ secrets.AWS_S3_ACCESS_KEY }}
      AWS_S3_SECRET_KEY:       ${{ secrets.AWS_S3_SECRET_KEY }}
      GCP_S3_ACCESS_KEY:       ${{ secrets.GCP_S3_ACCESS_KEY }}
      GCP_S3_SECRET_KEY:       ${{ secrets.GCP_S3_SECRET_KEY }}
      AZURE_CONNECTION_STRING: ${{ secrets.AZURE_CONNECTION_STRING }}

  # ── osx_arm64 ────────────────────────────────────────────────────────────────
  osx_arm64:
    name: osx_arm64
    uses: ./.github/workflows/build_with_conda_common.yml
    with:
      platform:                  osx_arm64
      runner:                    macos-14
      cmake_preset:              macos-conda-release
      cpp_out_dir:               cpp/out/macos-conda-release-build
      conda_cache_key:           conda-env-osx_arm64
      run_cpp_tests:             ${{ inputs.run_cpp_tests == true || github.event_name != 'workflow_dispatch' }}
      persistent_storage:        ${{ inputs.persistent_storage || 'no' }}
      debug_enabled:             ${{ inputs.debug_enabled || false }}
      run_enable_logging:        ${{ inputs.run_enable_logging || false }}
      run_commandline:           ${{ inputs.run_commandline || '' }}
      run_custom_pytest_command: ${{ inputs.run_custom_pytest_command || '' }}
    secrets:
      AWS_S3_ACCESS_KEY:       ${{ secrets.AWS_S3_ACCESS_KEY }}
      AWS_S3_SECRET_KEY:       ${{ secrets.AWS_S3_SECRET_KEY }}
      GCP_S3_ACCESS_KEY:       ${{ secrets.GCP_S3_ACCESS_KEY }}
      GCP_S3_SECRET_KEY:       ${{ secrets.GCP_S3_SECRET_KEY }}
      AZURE_CONNECTION_STRING: ${{ secrets.AZURE_CONNECTION_STRING }}

  # ── win_64 ───────────────────────────────────────────────────────────────────
  win_64:
    name: win_64
    uses: ./.github/workflows/build_with_conda_common.yml
    with:
      platform:                  win_64
      runner:                    windows-latest
      cmake_preset:              windows-cl-conda-release
      cpp_out_dir:               cpp/out/windows-cl-conda-release-build
      conda_cache_key:           conda-env-win_64
      run_cpp_tests:             ${{ inputs.run_cpp_tests == true || github.event_name != 'workflow_dispatch' }}
      persistent_storage:        ${{ inputs.persistent_storage || 'no' }}
      debug_enabled:             ${{ inputs.debug_enabled || false }}
      run_enable_logging:        ${{ inputs.run_enable_logging || false }}
      run_commandline:           ${{ inputs.run_commandline || '' }}
      run_custom_pytest_command: ${{ inputs.run_custom_pytest_command || '' }}
    secrets:
      AWS_S3_ACCESS_KEY:       ${{ secrets.AWS_S3_ACCESS_KEY }}
      AWS_S3_SECRET_KEY:       ${{ secrets.AWS_S3_SECRET_KEY }}
      GCP_S3_ACCESS_KEY:       ${{ secrets.GCP_S3_ACCESS_KEY }}
      GCP_S3_SECRET_KEY:       ${{ secrets.GCP_S3_SECRET_KEY }}
      AZURE_CONNECTION_STRING: ${{ secrets.AZURE_CONNECTION_STRING }}

  # ── Merge gate ───────────────────────────────────────────────────────────────
  can_merge_conda:
    name: All conda jobs completed
    needs: [linux_64, linux_aarch64, osx_arm64, win_64]
    if: always() && !failure() && !cancelled()
    runs-on: ubuntu-22.04
    steps:
      - run: echo All conda jobs completed!