name: __build_with_conda_common (reusable)

# This workflow is NOT triggered directly. It is called by build-conda.yml once
# per platform. All platform-specific values are passed in as inputs so every
# job step is written exactly once. Handles both Unix and Windows via conditionals.

on:
  workflow_call:
    inputs:
      # ── Identity ─────────────────────────────────────────────────────────
      platform:
        description: "Short platform label, e.g. linux_64"
        type: string
        required: true
      runner:
        description: "GitHub-hosted runner label, e.g. ubuntu-22.04"
        type: string
        required: true

      # ── CMake / build ─────────────────────────────────────────────────────
      cmake_preset:
        description: "CMake preset name, e.g. linux-conda-release"
        type: string
        required: true
      cpp_out_dir:
        description: "Relative path to the CMake output dir"
        type: string
        required: true

      # ── Conda ─────────────────────────────────────────────────────────────
      conda_cache_key:
        description: "cache-environment-key for micromamba"
        type: string
        required: true

      # ── Test knobs ────────────────────────────────────────────────────────
      run_cpp_tests:
        type: boolean
        default: true
      persistent_storage:
        type: string
        default: 'no'
      debug_enabled:
        type: boolean
        default: false
      run_enable_logging:
        type: boolean
        default: false
      run_commandline:
        type: string
        default: ""
      run_custom_pytest_command:
        type: string
        default: ""

    secrets:
      AWS_S3_ACCESS_KEY:       { required: false }
      AWS_S3_SECRET_KEY:       { required: false }
      GCP_S3_ACCESS_KEY:       { required: false }
      GCP_S3_SECRET_KEY:       { required: false }
      AZURE_CONNECTION_STRING: { required: false }

jobs:

  # ──────────────────────────────────────────────────────────────────────────
  compile:
    name: Compile
    runs-on: ${{inputs.runner}}
    env:
      # Both vars are harmless on the platform that doesn't need them.
      ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
      ACTIONS_ALLOW_UNSECURE_COMMANDS: true
      SCCACHE_GHA_VERSION: ${{vars.SCCACHE_GHA_VERSION || 1}}
      SCCACHE_GHA_ENABLED: "true"
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Configure sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: v0.12.0
          disable_annotations: 'true'

      - uses: SimenB/github-actions-cpu-cores@v2.0.0
        id: cpu-cores

      - name: Install Conda environment
        uses: mamba-org/setup-micromamba@v2.0.6
        with:
          environment-file: environment-dev.yml
          environment-name: arcticdb
          init-shell: bash
          cache-environment: true
          cache-environment-key: ${{inputs.conda_cache_key}}
          post-cleanup: 'none'

      # conda sets CMAKE_GENERATOR_{PLATFORM,TOOLSET} on Windows in a way that
      # prevents Ninja+MSVC. Unset them before building.
      # See: https://github.com/conda-forge/vc-feedstock/blob/c6bb71096319ff21ac8b75f7d91183be914c3d6b/recipe/activate.bat#L87-L131
      - name: Unset conda CMake generator overrides (Windows only)
        if: inputs.platform == 'win_64'
        run: |
          echo "CMAKE_GENERATOR_PLATFORM=" >> $GITHUB_ENV
          echo "CMAKE_GENERATOR_TOOLSET=" >> $GITHUB_ENV

      - name: Build ArcticDB
        run: python -m pip install --no-build-isolation --no-deps --retries 3 --timeout 400 -v -e .
        env:
          ARCTICDB_USING_CONDA: 1
          ARCTICDB_BUILD_CPP_TESTS: 1
          ARCTIC_CMAKE_PRESET: ${{inputs.cmake_preset}}

      - name: Show sccache stats
        run: ${SCCACHE_PATH} --show-stats || sccache --show-stats

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-${{inputs.platform}}
          retention-days: 7
          path: |
            ${{inputs.cpp_out_dir}}/
            python/arcticdb_ext*
            python/**/*.so
            python/**/*.pyd

  # ──────────────────────────────────────────────────────────────────────────
  cpp_tests:
    name: C++ Tests
    # Rapidcheck tests are disabled on Windows pending a linking fix.
    if: ${{inputs.run_cpp_tests && inputs.platform != 'win_64'}}
    needs: [compile]
    runs-on: ${{inputs.runner}}
    env:
      ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
      ACTIONS_ALLOW_UNSECURE_COMMANDS: true
      SCCACHE_GHA_VERSION: ${{vars.SCCACHE_GHA_VERSION || 1}}
      SCCACHE_GHA_ENABLED: "true"
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Configure sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: v0.12.0
          disable_annotations: 'true'

      - name: Free Disk Space
        if: ${{inputs.platform == 'linux_64' || inputs.platform == 'linux_aarch64'}}
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          large-packages: false
          docker-images: false

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{inputs.platform}}
          path: .

      - uses: SimenB/github-actions-cpu-cores@v2.0.0
        id: cpu-cores

      - name: Install Conda environment
        uses: mamba-org/setup-micromamba@v2.0.6
        with:
          environment-file: environment-dev.yml
          environment-name: arcticdb
          init-shell: bash
          cache-environment: true
          cache-environment-key: ${{inputs.conda_cache_key}}
          post-cleanup: 'none'

      - name: Configure C++ Tests
        run: |
          cache_file="${{inputs.cpp_out_dir}}/CMakeCache.txt"
          cd cpp
          if [ -f "$cache_file" ] && grep -q "TEST:BOOL=ON" "$cache_file"; then
            echo "CMake cache already has TEST=ON, skipping reconfiguration"
          else
            cmake --preset ${{inputs.cmake_preset}} -DTEST=ON
          fi
        env:
          ARCTICDB_USING_CONDA: 1

      - name: Build C++ Tests
        run: |
          cd cpp
          cmake --build --preset ${{inputs.cmake_preset}} --target arcticdb_rapidcheck_tests -j ${{steps.cpu-cores.outputs.count}}
          cmake --build --preset ${{inputs.cmake_preset}} --target test_unit_arcticdb -j ${{steps.cpu-cores.outputs.count}}
        env:
          ARCTICDB_USING_CONDA: 1

      - name: Show sccache stats
        run: ${SCCACHE_PATH} --show-stats || sccache --show-stats

      - name: Run C++ Tests
        run: |
          cd ${{inputs.cpp_out_dir}}
          ctest --output-on-failure
        env:
          ARCTICDB_USING_CONDA: 1

  # ──────────────────────────────────────────────────────────────────────────
  python_tests:
    name: Python Tests - ${{matrix.type}}
    needs: [compile]
    runs-on: ${{inputs.runner}}
    env:
      ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
      ACTIONS_ALLOW_UNSECURE_COMMANDS: true
      SCCACHE_GHA_VERSION: ${{vars.SCCACHE_GHA_VERSION || 1}}
    defaults:
      run:
        shell: bash -l {0}
    # NOTE: GitHub Actions does not support conditional service containers.
    # The mongo container starts on all runners; on macOS and Windows it is
    # unreachable and mongo-dependent tests are skipped by the test suite.
    services:
      mongodb:
        image: mongo:4.4
    strategy:
      fail-fast: false
      matrix:
        type: [unit, integration, hypothesis, stress, compat, enduser]
    steps:
      - name: Free Disk Space
        if: ${{inputs.platform == 'linux_64' || inputs.platform == 'linux_aarch64'}}
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          large-packages: false
          docker-images: false

      - uses: actions/checkout@v6.0.1

      - name: Configure sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: v0.12.0
          disable_annotations: 'true'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{inputs.platform}}
          path: .

      - uses: SimenB/github-actions-cpu-cores@v2.0.0
        id: cpu-cores

      - name: Install Conda environment
        uses: mamba-org/setup-micromamba@v2.0.6
        with:
          environment-file: environment-dev.yml
          environment-name: arcticdb
          init-shell: bash
          cache-environment: true
          cache-environment-key: ${{inputs.conda_cache_key}}
          post-cleanup: 'none'

      - name: Install ArcticDB from artifacts
        run: |
          if [ -d "${{inputs.cpp_out_dir}}" ] && (ls python/arcticdb_ext*.so python/arcticdb_ext*.pyd 2>/dev/null | head -1 | grep -q .); then
            echo "Build artifacts found, skipping CMake build"
            export ARCTIC_CMAKE_PRESET=skip
          fi
          python -m pip install --no-build-isolation --no-deps --retries 3 --timeout 400 -v -e .
        env:
          ARCTICDB_USING_CONDA: 1
          ARCTIC_CMAKE_PRESET: ${{inputs.cmake_preset}}

      - name: Install MongoDB (linux_64)
        if: inputs.platform == 'linux_64'
        uses: ./.github/actions/install_mongodb

      # linux_aarch64 cannot use the service container image — install manually.
      - name: Install MongoDB (linux_aarch64)
        if: inputs.platform == 'linux_aarch64'
        run: |
          curl -LO https://fastdl.mongodb.org/linux/mongodb-linux-aarch64-ubuntu2204-7.0.0.tgz
          tar -xzf mongodb-linux-aarch64-ubuntu2204-7.0.0.tgz
          cp mongodb-linux-aarch64-ubuntu2204-7.0.0/bin/* /usr/local/bin/
          mongod --version
          rm -rf mongodb-linux-aarch64-ubuntu2204-7.0.0.tgz mongodb-linux-aarch64-ubuntu2204-7.0.0

      - name: Install npm
        uses: actions/setup-node@v6.1.0
        with:
          node-version: '24'

      - name: Install Azurite
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: npm install -g azurite

      # On Windows, npm global installs may not be on PATH yet.
      - name: Add Azurite to PATH (Windows only)
        if: inputs.platform == 'win_64'
        run: |
          npm_bin=$(npm config get prefix | sed 's|^\([A-Z]\):|/\1|' | tr '[:upper:]' '[:lower:]' | sed 's|\\|/|g')
          echo "${npm_bin}" >> $GITHUB_PATH

      - name: Check no arcticdb file depends on tests package
        run: build_tooling/checks.sh

      - name: Set persistent storage variables
        if: ${{inputs.persistent_storage != 'no'}}
        uses: ./.github/actions/set_persistent_storage_env_vars
        with:
          aws_access_key: "${{secrets.AWS_S3_ACCESS_KEY}}"
          aws_secret_key: "${{secrets.AWS_S3_SECRET_KEY}}"
          gcp_access_key: "${{secrets.GCP_S3_ACCESS_KEY}}"
          gcp_secret_key: "${{secrets.GCP_S3_SECRET_KEY}}"
          azure_container: "githubblob"
          azure_connection_string: "${{secrets.AZURE_CONNECTION_STRING}}"
          persistent_storage: ${{inputs.persistent_storage}}

      - name: Set ArcticDB Debug Logging
        if: ${{inputs.run_enable_logging}}
        uses: ./.github/actions/enable_logging

      - name: Setup tmate session
        if: ${{inputs.debug_enabled}}
        uses: mxschmitt/action-tmate@v3

      - name: Install pytest-repeat
        run: python -m pip --retries 3 --timeout 180 install pytest-repeat

      - name: Test with pytest
        run: |
          openssl version -d
          ulimit -a
          echo "Run commandline: $COMMANDLINE"
          eval "$COMMANDLINE"
          export ARCTICDB_WARN_ON_WRITING_EMPTY_DATAFRAME=0
          if [[ "$(echo "$ARCTICDB_PYTEST_ARGS" | xargs)" == pytest* ]]; then
            python -m pip install pytest-repeat setuptools wheel
            python setup.py protoc --build-lib python
            echo "Run custom pytest command: $ARCTICDB_PYTEST_ARGS"
            eval "$ARCTICDB_PYTEST_ARGS"
          else
            cd python
            # LMDB tests are skipped on Windows — they fill the disk and cause suite failures.
            lmdb_filter=$([[ "$PLATFORM" == "win_64" ]] && echo "-m 'not lmdb'" || echo "")
            python -m pytest --timeout=3600 -v --tb=line -n logical --dist worksteal $lmdb_filter tests/${{matrix.type}} $ARCTICDB_PYTEST_ARGS
          fi
        env:
          ARCTICDB_USING_CONDA: 1
          PLATFORM: ${{inputs.platform}}
          COMMANDLINE: ${{inputs.run_commandline}}
          CI_MONGO_HOST: mongodb
          # osx_arm64 uses the macOS hypothesis profile; everything else uses the Linux profile.
          HYPOTHESIS_PROFILE: ${{inputs.platform == 'osx_arm64' && 'ci_macos' || 'ci_linux'}}
          ARCTICDB_PYTEST_ARGS: ${{inputs.run_custom_pytest_command}}
          STORAGE_TYPE: ${{inputs.persistent_storage == 'no' && 'LMDB' || inputs.persistent_storage}}
          NODE_OPTIONS: --openssl-legacy-provider