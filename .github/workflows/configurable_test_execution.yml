name: Configurable Test Execution

on:
  pull_request:
    types: [opened, synchronize]
    # edited is not used because it can trigger excessive runs
    # instead a manual run can be triggered when and if needed
  workflow_dispatch:

jobs:
  extract-config:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Get PR body
      id: get_pr
      uses: actions/github-script@v6
      with:
        script: |
          const pr = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number
          });
          return pr.data.body;

    - name: Extract config block
      id: extract_config
      env:
          PR_BODY: "${{ steps.get_pr.outputs.result }}"
      run: |
        echo "$PR_BODY" > raw_pr_body.txt
        echo "Raw PR test:"
        cat raw_pr_body.txt
        echo "\n\n\n\n\nNormalized line endings:"
        sed -i 's/\\r\\n/\n/g' raw_pr_body.txt

        awk '/---ConfigStart/,/---ConfigEnd/' raw_pr_body.txt | sed '1d;$d' > extracted_config.sh       

        echo "\n\n\n\n\nExtracted config extracted:"
        cat extracted_config.sh
        chmod +x extracted_config.sh
