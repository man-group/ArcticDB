name: Flaky Tests Summary
on:
  push:
  workflow_dispatch:
    inputs:
      since_date:
        description: 'Start date (inclusive) in YYYY-MM-DD format. Leave empty for all data.'
        required: false
        type: string
        default: ''

run-name: Flaky tests ${{ inputs.since_date && format('since {0}', inputs.since_date) || '(all data)' }}

permissions:
  contents: read

jobs:
  aggregate_flaky_tests:
    runs-on: ubuntu-22.04
    container:
      image: ubuntu:22.04
    steps:
      - name: Select Python
        uses: actions/setup-python@v4.7.1
        with:
          python-version: "3.11"

      - name: Checkout
        uses: actions/checkout@v3.3.0

      - name: Install requirements
        run: |
          apt update
          apt install -y git
          python3 -m pip install arcticdb[Testing] pandas 

      - name: Setup softlink for SSL
        shell: bash -el {0}
        run: |
          mkdir -p /etc/pki/tls
          ln -s /usr/lib/ssl/certs /etc/pki/tls/certs
          ln -s /etc/ssl/certs/ca-certificates.crt /etc/pki/tls/certs/ca-bundle.crt

      - name: Set persistent storage variables
        uses: ./.github/actions/set_persistent_storage_env_vars
        with:
          bucket: "arcticdb-ci-pytest-results"
          aws_access_key: "${{ secrets.AWS_S3_ACCESS_KEY }}"
          aws_secret_key: "${{ secrets.AWS_S3_SECRET_KEY }}"

      - name: Aggregate flaky tests
        run: |
          if [ -n "${{ inputs.since_date }}" ]; then
            python3 build_tooling/aggregate_flaky_tests.py --since "${{ inputs.since_date }}" --output "$GITHUB_STEP_SUMMARY" --md
          else
            python3 build_tooling/aggregate_flaky_tests.py --output "$GITHUB_STEP_SUMMARY" --md
          fi
