name: Build and Test
on:
  push:
    branches: ["**"]
    tags: [v**]
  workflow_dispatch:
    inputs:
      cmake_preset_type:
        description: Override the preset suffix for CMAKE only. Does not affect artifact upload.
        required: false
        type: choice
        options: [debug, release]
run-name: Building ${{github.ref}} on ${{github.event_name}} by ${{github.actor}} [${{inputs.cmake_preset_type}}]
jobs:
  # GitHub Actions don't allow YAML node references or other intra-file code reuse; instead, they use the clunky
  # "reusable workflows" files or "composite actions" which requires a separate repository.
  # Our build jobs share many steps and config, so instead of creating many workflow files and passing a millon params,
  # they're mostly in one "steps" file and we control which steps are enabled by passing a "job_type".

  cibw_container:
    uses: ./.github/workflows/cibw_docker_image.yml
    with:
      cibuildwheel_ver: "2.12.0"
      force_update: false

  leader-compile:
    # First do the C++ core compilation using one Python version to seed the compilation caches (and fail quicker)
    needs: [cibw_container]
    uses: ./.github/workflows/build_steps.yml
    with:
      job_type: leader-compile
      cmake_preset_type: ${{inputs.cmake_preset_type || (github.ref == 'refs/heads/master' && 'release' || 'debug') }}
      cibw_image_tag: ${{needs.cibw_container.outputs.tag}}

  leader-cpp-test:
    # Compile and run the C++ tests separately concurrently with the following job
    needs: [leader-compile, cibw_container]
    uses: ./.github/workflows/build_steps.yml
    with:
      job_type: cpp-tests
      cmake_preset_type: ${{inputs.cmake_preset_type || (github.ref == 'refs/heads/master' && 'release' || 'debug') }}
      cibw_image_tag: ${{needs.cibw_container.outputs.tag}}

  follower:
    # Then use the cached compilation artifacts to build other python versions concurrently in cibuildwheels
    needs: [leader-compile, cibw_container]
    uses: ./.github/workflows/build_steps.yml
    with:
      job_type: follower
      cmake_preset_type: ${{inputs.cmake_preset_type || (github.ref == 'refs/heads/master' && 'release' || 'debug') }}
      cibuildwheel_ver: "2.12.0"  # Must match the cibw_container job above
      cibw_image_tag: ${{needs.cibw_container.outputs.tag}}
